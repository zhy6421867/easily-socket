"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var Socket=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=1<arguments.length?arguments[1]:void 0;_classCallCheck(this,n),this.heartBeatTimer=null,this.options=t,this.messageMap={},this.connState=0,this.socket=null,this.url=e,this.timeout=6e4,this.connetCount=10}return _createClass(n,[{key:"doOpen",value:function(){var t=this;if(!this.connState){this.connState=1,this.afterOpenEmit=[];var e=new(window.WebSocket||window.MozWebSocket)(this.url);e.binaryType="arraybuffer",e.onopen=function(e){return t.onOpen(e)},e.onclose=function(e){return t.onClose(e)},e.onmessage=function(e){return t.onMessage(e.data)},e.onerror=function(e){return t.onError(e)},this.socket=e}}},{key:"onOpen",value:function(e){this.connState=2,this.heartBeatTimer=setInterval(this.checkHeartbeat.bind(this),3e4),this.onReceiver({Event:"open"})}},{key:"checkOpen",value:function(){return 2===this.connState}},{key:"onClose",value:function(){var e=this;this.connState=0,this.connState&&this.onReceiver({Event:"close"}),-1<this.connetCount&&setTimeout(function(){e.doOpen(),e.connetCount--},5e3)}},{key:"send",value:function(e){this.checkOpen()&&this.socket.send(JSON.stringify(e))}},{key:"emit",value:function(e){var n=this;return new Promise(function(t){n.socket.send(JSON.stringify(e)),n.on("message",function(e){t(e)})})}},{key:"onMessage",value:function(e){try{var t=JSON.parse(e);this.onReceiver({Event:"message",Data:t})}catch(e){console.error(" >> Data parsing error:",e)}}},{key:"checkHeartbeat",value:function(){var e={cmd:"ping",args:[Date.parse(new Date)]};this.send(e)}},{key:"onError",value:function(e){console.error(e)}},{key:"onReceiver",value:function(e){var t=this.messageMap[e.Event];t&&t(e.Data)}},{key:"on",value:function(e,t){this.messageMap[e]=t}},{key:"doClose",value:function(){this.socket.close()}},{key:"destroy",value:function(){this.heartBeatTimer&&(clearInterval(this.heartBeatTimer),this.heartBeatTimer=null),this.connetCount=-1,this.doClose(),this.messageMap={},this.connState=0,this.socket=null}}]),n}();module.exports=Socket;
